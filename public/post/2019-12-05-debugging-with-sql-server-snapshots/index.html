<!doctype html>





























<html
  class="not-ready lg:text-base"
  style="--bg: #faf8f1"
  lang="en-au"
>
  <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, shrink-to-fit=no"
  />

  
  <title>Keep your dev loop as short as possible with SQL Server Snapshots - Blogilreavy</title>

  
  <meta name="theme-color" />

  
  
  
  
  <meta name="description" content="How to make use of Sql Server Snapshots to keep your dev loop as short as possible." />
  <meta name="author" content="Blogilreavy" />
  

  
  
  
  
  
  
  <link rel="preload stylesheet" as="style" href="http://localhost:1313/main.min.css" />

  
  
  
  
  
  <link rel="preload" as="image" href="http://localhost:1313/theme.png" />

  
  
  
  
  

  
  
  

  
  
  <script
    defer
    src="http://localhost:1313/highlight.min.js"
    onload="hljs.initHighlightingOnLoad();"
  ></script>
  

  
  
  

  
  <link rel="icon" href="http://localhost:1313/favicon.ico" />
  <link rel="apple-touch-icon" href="http://localhost:1313/apple-touch-icon.png" />

  
  <meta name="generator" content="Hugo 0.124.1">

  
  
  
</head>

  <body class="text-black duration-200 ease-out dark:text-white">
    <header class="mx-auto flex h-[4.5rem] max-w-3xl px-8 lg:justify-center">
  <div class="relative z-50 mr-auto flex items-center">
    <a
      class="-translate-x-[1px] -translate-y-[1px] text-2xl font-semibold"
      href="http://localhost:1313/"
      >Blogilreavy</a
    >
    <div
      class="btn-dark text-[0] ml-4 h-6 w-6 shrink-0 cursor-pointer [background:url(./theme.png)_left_center/_auto_theme('spacing.6')_no-repeat] [transition:_background-position_0.4s_steps(5)] dark:[background-position:right]"
      role="button"
      aria-label="Dark"
    ></div>
  </div>

  <div
    class="btn-menu relative z-50 -mr-8 flex h-[4.5rem] w-[5rem] shrink-0 cursor-pointer flex-col items-center justify-center gap-2.5 lg:hidden"
    role="button"
    aria-label="Menu"
  ></div>

  

  <script>
    
    const htmlClass = document.documentElement.classList;
    setTimeout(() => {
      htmlClass.remove('not-ready');
    }, 10);

    
    const btnMenu = document.querySelector('.btn-menu');
    btnMenu.addEventListener('click', () => {
      htmlClass.toggle('open');
    });

    
    const metaTheme = document.querySelector('meta[name="theme-color"]');
    const lightBg = '#faf8f1'.replace(/"/g, '');
    const setDark = (isDark) => {
      metaTheme.setAttribute('content', isDark ? '#000' : lightBg);
      htmlClass[isDark ? 'add' : 'remove']('dark');
      localStorage.setItem('dark', isDark);
    };

    
    const darkScheme = window.matchMedia('(prefers-color-scheme: dark)');
    if (htmlClass.contains('dark')) {
      setDark(true);
    } else {
      const darkVal = localStorage.getItem('dark');
      setDark(darkVal ? darkVal === 'true' : darkScheme.matches);
    }

    
    darkScheme.addEventListener('change', (event) => {
      setDark(event.matches);
    });

    
    const btnDark = document.querySelector('.btn-dark');
    btnDark.addEventListener('click', () => {
      setDark(localStorage.getItem('dark') !== 'true');
    });
  </script>

  <div
    class="nav-wrapper fixed inset-x-0 top-full z-40 flex h-full select-none flex-col justify-center pb-16 duration-200 dark:bg-black lg:static lg:h-auto lg:flex-row lg:!bg-transparent lg:pb-0 lg:transition-none"
  >
    
    

    
  </div>
</header>


    <main
      class="prose prose-neutral relative mx-auto min-h-[calc(100%-9rem)] max-w-3xl px-8 pb-16 pt-12 dark:prose-invert"
    >
      

<article>
  <header class="mb-16">
    <h1 class="!my-0 pb-2.5">Keep your dev loop as short as possible with SQL Server Snapshots</h1>

    
    <div class="text-sm antialiased opacity-60">
      
      <time>Dec 5, 2019</time>
      
      
      
      
    </div>
    
  </header>

  <section><p><em><strong>tl;dr</strong></em> Sql Server Snapshots are a useful feature to reduce the pain of breaking changes when switching branches or when debugging scenarios that require complex data setups.</p>
<h2 id="problems">Problems</h2>
<p>So what are the problems that snapshots can help with? Well, there are a couple of them that a developer might face daily&hellip;</p>
<h3 id="switching-branches">Switching Branches</h3>
<p>Often when developing, you need to switch between branches e.g. <code>master</code> -&gt; <code>my-feature-branch</code> and back again. Or you might need to switch to <code>someone-elses-feature-branch</code> so that you can review or test someone else&rsquo;s code. Often doing this puts your local database schema out of sync with the code and you end up with exceptions. In one branch there might be an extra column in a table for example.</p>
<p>Resolving these conflicts can be a pain. You waste time finding the problem and you have to come up with a script to fix it.</p>
<h3 id="debugging-complex-data-scenarios">Debugging Complex Data Scenarios</h3>
<p>Bugs have a habit of happening in dark, hard to reach corners of your application. They often require a very specific set of data to reproduce them. This data setup can be a tedious and time-consuming task. Often, during the act of reproducing the bug, the data scenario you just spent time carefully creating gets deleted or changed so that you have to then spend more time re-creating it to run it again.</p>
<p>Ideally, you want your dev loop to be as short as possible otherwise insights and discoveries about what might be causing this bug will take longer to achieve. So it would be really useful to have a way to instantly restore this data to its original state before the code was executed.</p>
<h2 id="how-can-snapshots-help">How can Snapshots help?</h2>
<p>A <a href="https://docs.microsoft.com/en-us/sql/relational-databases/databases/database-snapshots-sql-server">snapshot</a> of a Sql Server database is a <em>point-in-time</em> copy of a source Sql Server database.</p>
<p><img src="./ssms-snapshots.png" alt="Snapshot"></p>
<p>A snapshot is somewhat similar to a <code>.bak</code> or <code>.bacpac</code> backup, in so much as they are all <em>copies</em> of the database. These methods though involve exporting a copy of the source database to a file which you can later restore when needed.</p>
<p>A snapshot is slightly different, it is also a point-in-time copy of your source database. When created it becomes an <em>attached</em> <em>read-only</em> copy of the source. A snapshot is shown in Sql Server Management Studio, under a menu folder called <em>&lsquo;Database Snapshots&rsquo;</em> (shown above). You can access and browse these just like regular databases. They are read-only though so they can&rsquo;t be modified.</p>
<p>You might be wondering, if a snapshot is read-only, what use can it be? Well, another cool feature of a database snapshot is that you can restore <em>from</em> them back to a regular database. And it&rsquo;s fast. A lot faster than restoring from a <code>.bak</code> or <code>.bacpac</code> for example.</p>
<p>Let&rsquo;s have a look at the process.</p>
<h2 id="working-with-snapshots">Working with Snapshots</h2>
<p>Here are the typical steps of how you can work with a snapshot: -</p>
<ol>
<li>Create the known good state of local database (either manually or grab a copy of a production database).</li>
<li>Create a snapshot of your local database in this known state that you&rsquo;ll return to each time.</li>
<li><em>Do the thing that messes up your local Db</em>. i.e. Reproduce a bug that needs a complex data scenario (<em>data gets ruined in the process</em>) or make schema changes in another branch etc.</li>
<li>Restore your local database from the snapshot.</li>
<li>Repeat from step 3 (or 1) as needed!</li>
</ol>
<h2 id="creating-a-snapshot">Creating a Snapshot</h2>
<p>So once your local source database is in the known good state that you wish to capture, you&rsquo;re ready to create a snapshot of it.</p>
<blockquote>
<p>NOTE: In these examples, I&rsquo;ll be using the <a href="https://github.com/microsoft/sql-server-samples/tree/master/samples/databases/wide-world-importers"><em>World Wide Importers</em></a> example database which you can download from <a href="https://github.com/microsoft/sql-server-samples/releases/download/wide-world-importers-v1.0/WideWorldImporters-Standard.bak">here</a>.</p>
</blockquote>
<p>Here&rsquo;s what the SQL looks like for my <code>WideWorldImporters</code> database looks like.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-SQL" data-lang="SQL"><span style="display:flex;"><span><span style="color:#66d9ef">DROP</span> <span style="color:#66d9ef">DATABASE</span> <span style="color:#66d9ef">IF</span> <span style="color:#66d9ef">EXISTS</span> [WideWorldImporters_Snapshot];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">DATABASE</span> [WideWorldImporters_Snapshot] <span style="color:#66d9ef">ON</span>
</span></span><span style="display:flex;"><span>(
</span></span><span style="display:flex;"><span>       NAME <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;WideWorldImporters_Data&#39;</span>,
</span></span><span style="display:flex;"><span>       FILENAME <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;C:\MySnapshots\WideWorldImporters_Data.ss&#39;</span>
</span></span><span style="display:flex;"><span>),
</span></span><span style="display:flex;"><span>(
</span></span><span style="display:flex;"><span>       NAME <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;USERDATA_6D7F02AB&#39;</span>,
</span></span><span style="display:flex;"><span>       FILENAME <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;C:\MySnapshots\USERDATA_6D7F02AB.ss&#39;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">AS</span> SNAPSHOT <span style="color:#66d9ef">OF</span> [WideWorldImporters];
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">GO</span>
</span></span></code></pre></div><p>First we drop any existing snapshot. This just makes it easier to quickly update the snapshot.</p>
<p>When creating a snapshot we need to make copies of each data file of the source database. In this example, we have two datafiles named <code>WideWorldImporters_Data</code> or <code>USERDATA_6D7F02AB</code> so there is a section for each in the <code>CREATE</code> statement. In each section, we specify the file where we&rsquo;d like to save the snapshot file. The convention is to name these file with an <code>.ss</code> extension.</p>
<p>To find the names of your data files you can run the following <code>SELECT</code> statement and use the results to construct your own <code>CREATE</code> statement.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-SQL" data-lang="SQL"><span style="display:flex;"><span><span style="color:#66d9ef">SELECT</span> [name] <span style="color:#66d9ef">FROM</span> [sys].[master_files] <span style="color:#66d9ef">WHERE</span> [database_id] <span style="color:#f92672">=</span> DB_ID(<span style="color:#e6db74">&#39;WideWorldImporters&#39;</span>) <span style="color:#66d9ef">AND</span> [<span style="color:#66d9ef">type</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span></code></pre></div><p><img src="./data-file-names.png" alt="Data File Names"></p>
<h2 id="restoring-from-a-snapshot">Restoring from a Snapshot</h2>
<p>When we need to return our source database to it&rsquo;s know state we can restore it <em>from</em> the snapshot. When we do this the snapshot remains unchanged. So we can restore from it as many times as we need to.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-SQL" data-lang="SQL"><span style="display:flex;"><span>USE [Master];
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">GO</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">ALTER</span> <span style="color:#66d9ef">DATABASE</span> [WideWorldImporters] <span style="color:#66d9ef">SET</span> SINGLE_USER <span style="color:#66d9ef">WITH</span> <span style="color:#66d9ef">ROLLBACK</span> <span style="color:#66d9ef">IMMEDIATE</span>;
</span></span><span style="display:flex;"><span>RESTORE <span style="color:#66d9ef">DATABASE</span> [WideWorldImporters] <span style="color:#66d9ef">FROM</span> DATABASE_SNAPSHOT <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;WideWorldImporters_Snapshot&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">ALTER</span> <span style="color:#66d9ef">DATABASE</span> [WideWorldImporters] <span style="color:#66d9ef">SET</span> MULTI_USER;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">GO</span>
</span></span></code></pre></div><p>Firstly, because we need to make changes to our source database we need to first switch to <code>master</code>.
Then we put the source database into single-user mode and make sure any existing connections our application might have open are closed.
This makes sure we can then restore our database from the snapshot.
Finally, we put the freshly restore the database back into mutli-user mode so it can again begin accepting connections from out application.</p>
<p>That&rsquo;s it. Your application database (<code>WideWorldImporters</code>) has now been re-created from the snapshot (<code>WideWorldImporters_Snapshot</code>).</p>
<h1 id="conclusion">Conclusion</h1>
<p>Sql Server Snapshots are useful to keep your dev loop as short as possible by allowing you to return your local database back to a known state very quickly.</p>
<p>Thanks for reading.</p>
</section>

  
  

  
  
  
  
  <nav class="mt-24 flex rounded-lg bg-black/[3%] text-lg dark:bg-white/[8%]">
    
    <a
      class="flex w-1/2 items-center rounded-l-md p-6 pr-3 font-semibold no-underline hover:bg-black/[2%] dark:hover:bg-white/[3%]"
      href="http://localhost:1313/post/2021-01-03-sql-server-high-dpi-settings/"
      ><span class="mr-1.5">←</span><span>SQL Server High Dpi Settings</span></a
    >
    
    
    <a
      class="ml-auto flex w-1/2 items-center justify-end rounded-r-md p-6 pl-3 font-semibold no-underline hover:bg-black/[2%] dark:hover:bg-white/[3%]"
      href="http://localhost:1313/post/2019-02-02-creating-an-eventgrid-simulator/"
      ><span>Creating an Azure Event Grid Simulator</span><span class="ml-1.5">→</span></a
    >
    
  </nav>
  
  

  
  
  <div class="mt-24" id="disqus_thread"></div>
  <script>
    const disqusShortname = 'blogilreavy';
    const script = document.createElement('script');
    script.src = 'https://' + disqusShortname + '.disqus.com/embed.js';
    script.setAttribute('data-timestamp', +new Date());
    document.head.appendChild(script);
  </script>
  

  
  

  


  
</article>


    </main>

    <footer
  class="opaco mx-auto flex h-[4.5rem] max-w-3xl items-center px-8 text-[0.9em] opacity-60"
>
  <div class="mr-auto">
    &copy; 2024
    <a class="link" href="http://localhost:1313/">Blogilreavy</a>
  </div>
  <a class="link mx-6" href="https://gohugo.io/" rel="noopener" target="_blank"
    >Powered by Hugo️️</a
  >️
  <a
    class="link"
    href="https://github.com/nanxiaobei/hugo-paper"
    rel="noopener"
    target="_blank"
    >✎ Paper</a
  >
</footer>

  </body>
</html>
