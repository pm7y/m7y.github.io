<!doctype html>





























<html
  class="not-ready lg:text-base"
  style="--bg: #faf8f1"
  lang="en-au"
>
  <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, shrink-to-fit=no"
  />

  
  <title>The CallerArgumentExpression Attribute in C# 8.0 - Blogilreavy</title>

  
  <meta name="theme-color" />

  
  
  
  
  <meta name="description" content="An exploration of how the new C# 8 CallerArgumentExpression attribute could enhance my open source &lsquo;GuardAgainst&rsquo; library." />
  <meta name="author" content="Blogilreavy" />
  

  
  
  
  
  
  
  <link rel="preload stylesheet" as="style" href="http://localhost:1313/main.min.css" />

  
  
  
  
  
  <link rel="preload" as="image" href="http://localhost:1313/theme.png" />

  
  
  
  
  

  
  
  

  
  
  <script
    defer
    src="http://localhost:1313/highlight.min.js"
    onload="hljs.initHighlightingOnLoad();"
  ></script>
  

  
  
  

  
  <link rel="icon" href="http://localhost:1313/favicon.ico" />
  <link rel="apple-touch-icon" href="http://localhost:1313/apple-touch-icon.png" />

  
  <meta name="generator" content="Hugo 0.124.1">

  
  
  
</head>

  <body class="text-black duration-200 ease-out dark:text-white">
    <header class="mx-auto flex h-[4.5rem] max-w-3xl px-8 lg:justify-center">
  <div class="relative z-50 mr-auto flex items-center">
    <a
      class="-translate-x-[1px] -translate-y-[1px] text-2xl font-semibold"
      href="http://localhost:1313/"
      >Blogilreavy</a
    >
    <div
      class="btn-dark text-[0] ml-4 h-6 w-6 shrink-0 cursor-pointer [background:url(./theme.png)_left_center/_auto_theme('spacing.6')_no-repeat] [transition:_background-position_0.4s_steps(5)] dark:[background-position:right]"
      role="button"
      aria-label="Dark"
    ></div>
  </div>

  <div
    class="btn-menu relative z-50 -mr-8 flex h-[4.5rem] w-[5rem] shrink-0 cursor-pointer flex-col items-center justify-center gap-2.5 lg:hidden"
    role="button"
    aria-label="Menu"
  ></div>

  

  <script>
    
    const htmlClass = document.documentElement.classList;
    setTimeout(() => {
      htmlClass.remove('not-ready');
    }, 10);

    
    const btnMenu = document.querySelector('.btn-menu');
    btnMenu.addEventListener('click', () => {
      htmlClass.toggle('open');
    });

    
    const metaTheme = document.querySelector('meta[name="theme-color"]');
    const lightBg = '#faf8f1'.replace(/"/g, '');
    const setDark = (isDark) => {
      metaTheme.setAttribute('content', isDark ? '#000' : lightBg);
      htmlClass[isDark ? 'add' : 'remove']('dark');
      localStorage.setItem('dark', isDark);
    };

    
    const darkScheme = window.matchMedia('(prefers-color-scheme: dark)');
    if (htmlClass.contains('dark')) {
      setDark(true);
    } else {
      const darkVal = localStorage.getItem('dark');
      setDark(darkVal ? darkVal === 'true' : darkScheme.matches);
    }

    
    darkScheme.addEventListener('change', (event) => {
      setDark(event.matches);
    });

    
    const btnDark = document.querySelector('.btn-dark');
    btnDark.addEventListener('click', () => {
      setDark(localStorage.getItem('dark') !== 'true');
    });
  </script>

  <div
    class="nav-wrapper fixed inset-x-0 top-full z-40 flex h-full select-none flex-col justify-center pb-16 duration-200 dark:bg-black lg:static lg:h-auto lg:flex-row lg:!bg-transparent lg:pb-0 lg:transition-none"
  >
    
    

    
  </div>
</header>


    <main
      class="prose prose-neutral relative mx-auto min-h-[calc(100%-9rem)] max-w-3xl px-8 pb-16 pt-12 dark:prose-invert"
    >
      

<article>
  <header class="mb-16">
    <h1 class="!my-0 pb-2.5">The CallerArgumentExpression Attribute in C# 8.0</h1>

    
    <div class="text-sm antialiased opacity-60">
      
      <time>Aug 6, 2018</time>
      
      
      
      
    </div>
    
  </header>

  <section><p>I like C#. I can remember downloading the first beta and playing with C# for the first time and thinking it was a lot like Java, which made it instantly familiar to me. C# 8.0 is due soon. We don&rsquo;t know when, Microsoft hasn&rsquo;t officially announced a date yet. But if we go by the release dates of the previous major versions we could expect C# 8.0 to drop sometime in 2019.</p>
<p>Microsoft now develops <em>all the things</em> in the open and so detailed design specs for each of the proposed new features for C# 8.0 can be found on <em><a href="https://github.com/dotnet/csharplang/tree/master/proposals">GitHub</a></em>. There are several often blogged about headline features such as: nullable reference types, async streams and <em>extension everything</em>. In this post though I want to focus on one of the more low key features, the <a href="https://github.com/dotnet/csharplang/blob/master/proposals/caller-argument-expression.md"><em><strong>CallerArgumentExpression Attribute</strong></em></a> and how it could greatly simplify one of my open source projects, <em><a href="https://github.com/pmcilreavy/GuardAgainst">GuardAgainst</a></em>.</p>
<h2 id="guardagainst">GuardAgainst</h2>
<p>So let me tell you about a small, unambitious project I have on GitHub called <em><a href="https://github.com/pmcilreavy/GuardAgainst">GuardAgainst</a></em>. It&rsquo;s a library to make writing guard clauses for your methods trivial.</p>
<p><img src="./guardagainst.png" alt="GuardAgainst"></p>
<p>Methods are contracts. They accept arguments, do <em>stuff</em> with them and potentially return a value. If a method cannot meet the contract based on the given arguments it should throw an appropriate exception.</p>
<p>Writing these <em>guard clauses</em>, that throw if arguments are not valid, is tedious work and introduces noise and clutter to the code. The goal of <em>GuardAgainst</em> is to make writing these guard clauses concise and expressive. Consider the following simplistic example of a method that accepts two strings and concatenates them together.</p>
<pre tabindex="0"><code>private static string GetFullname(string firstname, string surname)
{
if (firstname is null)
{
throw new ArgumentNullException(nameof(firstname), &#34;Firstname is required.&#34;);
}

    if (string.IsNullOrWhiteSpace(firstname))
    {
        throw new ArgumentException(&#34;Firstname is required.&#34;, nameof(firstname));
    }

    if (surname is null)
    {
        throw new ArgumentNullException(nameof(surname));
    }

    if (string.IsNullOrWhiteSpace(surname))
    {
        throw new ArgumentException(&#34;Surname is required.&#34;, nameof(surname));
    }

    return $&#34;{firstname} {surname}&#34;;

}
</code></pre><p>First we check that each argument is not null. If it is we throw an <code>ArgumentNullException</code> exception. If not we then check that it&rsquo;s not just whitespace and if it is we throw an <code>ArgumentException</code>. This is because <code>ArgumentNullException</code> and <code>ArgumentException</code> convey different meanings and we want to be as precise as possible about why the argument does not meet the method contract. So we end up with four guard clauses. Two for each of our arguments. A developer reading this code has to mentally parse each clause and move on until they get to the actual meat of the method.</p>
<p><em>GuardAgainst</em> provides a bunch of methods to reduce this code into much neater calls that are named carefully to be very readable and clearly express their intent. So the code in the above example would become this&hellip;</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">string</span> GetFullname(<span style="color:#66d9ef">string</span> firstname, <span style="color:#66d9ef">string</span> surname)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>GuardAgainst.ArgumentBeingNullOrWhitespace(firstname, nameof(firstname), <span style="color:#e6db74">&#34;Firstname is required.&#34;</span>);
</span></span><span style="display:flex;"><span>GuardAgainst.ArgumentBeingNullOrWhitespace(surname, nameof(surname), <span style="color:#e6db74">&#34;Surname is required.&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#e6db74">$&#34;{firstname} {surname}&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>There are many such libraries available but I felt the need to create another one as they often suffer from usability issues (bad naming, clunky methods), performance issues (reflection, boxing) or simply don&rsquo;t have the range of features to check the conditions I wanted to be able to guard against. I also designed it as a single file that could be dropped into a project so that consumers do not have to take a dependency on a dll or a nuget package.</p>
<p>Even though I&rsquo;ve tried to keep the usage of this library as simple as possible. The new <em>CallerArgumentExpression</em> could dramatically simplify things even further. Let&rsquo;s first look at how I implement a typical method in the library.</p>
<h3 id="how-guardagainst-currently-works">How GuardAgainst currently works</h3>
<p>Here is a <em>simplified</em> example of what a typical guard method in the library looks like and how it&rsquo;s called.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> ArgumentBeingNull&lt;T&gt;(T argumentValue,
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">string</span> argumentName = <span style="color:#66d9ef">default</span>(<span style="color:#66d9ef">string</span>))
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">where</span> T : <span style="color:#66d9ef">class</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (argumentValue != <span style="color:#66d9ef">null</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> ArgumentNullException(argumentName);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>GuardAgainst.ArgumentBeingNull(firstname, nameof(firstname));
</span></span></code></pre></div><p>In this example we are guarding against an argument being <code>null</code> so we pass the value that we want to check: <code>firstname</code>. If <code>argumentValue</code> isn&rsquo;t null then we just return. If it is null then we throw an <code>ArgumentNullException</code>. Pretty simple.</p>
<h3 id="the-problem">The Problem</h3>
<p>In order to make this useful we also need to pass in the <em>name</em> of the argument to the constructor of the exception. If we have several parameters then having the name in the exception makes it obvious which parameter caused the fault. The problem is that there is no way to get this name unless the caller of the method passes it in for us.</p>
<p>I&rsquo;ve never liked this. It&rsquo;s a clunky necessity that adds friction to the api. The ultimate goal is to be able to <em>know</em> the name of argument being passed in without the developer having to actually pass it in via another argument.</p>
<h3 id="a-possible-approach">A Possible Approach</h3>
<p>One possible way I could achieve this goal right now with current C# is by making <code>ArgumentBeingNull</code> accept an <code>Expression&lt;Func&lt;T&gt;&gt;</code> and have the caller pass in an expression that evaluates to the <em>thing</em> to be checked for null. I&rsquo;d also then be able to get the string representation of that argument too. Sounds good, let&rsquo;s have a look.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> ArgumentBeingNull&lt;T&gt;(Expression&lt;Func&lt;T&gt;&gt; argumentExpression)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">where</span> T : <span style="color:#66d9ef">class</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> argumentValue = argumentExpression.Compile().Invoke();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (argumentValue != <span style="color:#66d9ef">null</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> expressionBody = argumentExpression.Body.ToString();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> valueExpressionRegex = <span style="color:#66d9ef">new</span> Regex(<span style="color:#e6db74">@&#34;(value\()(.*)(\).)&#34;</span>, RegexOptions.CultureInvariant);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> valueMatch = valueExpressionRegex.Match(expressionBody);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> argumentValueString = valueMatch.Success ? expressionBody.Remove(valueMatch.Value) : expressionBody;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> ArgumentNullException(<span style="color:#66d9ef">null</span>, <span style="color:#e6db74">$&#34;&#39;{argumentValueString}&#39; was null!&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>GuardAgainst.ArgumentBeingNull(() =&gt; firstname);
</span></span></code></pre></div><p>I&rsquo;ve not yet added this to the GuardAgainst library as there are a couple of things I&rsquo;m not overly happy about. The first is performance. This is not a huge issue based on some crude tests but it&rsquo;s significant enough to give me pause.</p>
<p>The second and main reason I&rsquo;ve not done this is I think forcing people to write an expression like <code>() =&gt; firstname</code> is just as weird and awkward as making them pass in the name of the argument. Clunky weirdness is what I&rsquo;m trying to avoid.</p>
<blockquote>
<p>The ultimate goal is to be able to <em>know</em> the name of argument being passed in without the developer having to actually pass it in via another argument.</p>
</blockquote>
<h3 id="callerargumentexpression-to-the-rescue">CallerArgumentExpression to the rescue</h3>
<p>The new <em>CallerArgumentExpression</em> attribute proposed for C# 8.0 would be a great solution to this problem. Now consider the following code which is identical to my initial <code>ArgumentBeingNull</code> example above except that I&rsquo;ve added the <em>CallerArgumentExpression</em> attribute to the <code>argumentName</code> parameter.</p>
<p>The compiler recognises the <em>CallerArgumentExpression</em> attribute and uses the string passed to its constructor (i.e. <code>argumentValue</code>) to target that parameter and converts the incoming expression to a string which is assigned to the <code>argumentName</code> parameter.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> ArgumentBeingNull&lt;T&gt;(T argumentValue,
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">[CallerArgumentExpression(&#34;argumentValue&#34;)]</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">string</span> argumentName = <span style="color:#66d9ef">default</span>(<span style="color:#66d9ef">string</span>))
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">where</span> T : <span style="color:#66d9ef">class</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (argumentValue != <span style="color:#66d9ef">null</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> ArgumentNullException(argumentName);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>What a developer would write to call it &hellip;</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>GuardAgainst.ArgumentBeingNull(firstname);
</span></span></code></pre></div><p>What the compiler effectively emits&hellip;</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>GuardAgainst.ArgumentBeingNull(firstname, <span style="color:#e6db74">&#34;firstname&#34;</span>);
</span></span></code></pre></div><blockquote>
<p>&ldquo;Allows developers to capture the expressions passed to a method, to enable better error messages in diagnostic/testing APIs and reduce keystrokes.&rdquo;</p>
</blockquote>
<p>The <em>CallerArgumentExpression</em> attribute is effectively giving me the <code>Expression&lt;Func&lt;T&gt;&gt;</code> solution I was toying with but without the performance overhead and without the clunky <code>() =&gt; firstname</code> syntax.</p>
<p>Not only would this be a super easy code change for me to implement, I would just need to add the <em>CallerArgumentExpression</em> attribute and I&rsquo;m done. It would also mean that callers of the library would just pass in the value of the argument they wish to guard against being null as they&rsquo;ve always done but they would no longer have to explicitly specify the name. Ultimate goal achieved!</p>
</section>

  
  

  
  
  
  
  <nav class="mt-24 flex rounded-lg bg-black/[3%] text-lg dark:bg-white/[8%]">
    
    <a
      class="flex w-1/2 items-center rounded-l-md p-6 pr-3 font-semibold no-underline hover:bg-black/[2%] dark:hover:bg-white/[3%]"
      href="http://localhost:1313/post/2018-09-12-readify-consultant-toolbelt/"
      ><span class="mr-1.5">←</span><span>Readify Consultant Toolbelt</span></a
    >
    
    
    <a
      class="ml-auto flex w-1/2 items-center justify-end rounded-r-md p-6 pl-3 font-semibold no-underline hover:bg-black/[2%] dark:hover:bg-white/[3%]"
      href="http://localhost:1313/post/2018-03-29-octopus-deploy-slack-notifications/"
      ><span>Using an Azure function to get Octopus deployment notifications in Slack</span><span class="ml-1.5">→</span></a
    >
    
  </nav>
  
  

  
  
  <div class="mt-24" id="disqus_thread"></div>
  <script>
    const disqusShortname = 'blogilreavy';
    const script = document.createElement('script');
    script.src = 'https://' + disqusShortname + '.disqus.com/embed.js';
    script.setAttribute('data-timestamp', +new Date());
    document.head.appendChild(script);
  </script>
  

  
  

  


  
</article>


    </main>

    <footer
  class="opaco mx-auto flex h-[4.5rem] max-w-3xl items-center px-8 text-[0.9em] opacity-60"
>
  <div class="mr-auto">
    &copy; 2024
    <a class="link" href="http://localhost:1313/">Blogilreavy</a>
  </div>
  <a class="link mx-6" href="https://gohugo.io/" rel="noopener" target="_blank"
    >Powered by Hugo️️</a
  >️
  <a
    class="link"
    href="https://github.com/nanxiaobei/hugo-paper"
    rel="noopener"
    target="_blank"
    >✎ Paper</a
  >
</footer>

  </body>
</html>
